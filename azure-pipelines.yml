trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - 'tests/**'
      - 'src/**'
      - 'package.json'
      - 'playwright.config.ts'

pr:
  branches:
    include:
      - main
      - develop

# schedules removed - pipeline runs only on-demand or when code changes are pushed

pool:
  vmImage: 'ubuntu-latest'

parameters:
  # Allow manual selection of test suite - limited to smoke and regression only
  - name: testSuite
    displayName: 'Select Test Suite'
    type: string
    default: 'smoke'
    values:
      - smoke
      - regression

variables:
  NODE_VERSION: '20.x'
  CI: 'true'
  # Define test commands for smoke and regression
  ${{ if eq(parameters.testSuite, 'smoke') }}:
    TEST_COMMAND: 'npm run test:account-management:ci'
  ${{ if eq(parameters.testSuite, 'regression') }}:
    TEST_COMMAND: 'npm run test:all-modules:ci'

stages:
  - stage: Test
    displayName: 'Run Playwright Tests - ${{ parameters.testSuite }}'
    jobs:
      - job: PlaywrightTests
        displayName: 'Execute ${{ parameters.testSuite }} Tests'
        timeoutInMinutes: 60
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'
          
          - script: |
              export CI=true
              $(TEST_COMMAND)
            displayName: 'Run ${{ parameters.testSuite }} Tests'
            continueOnError: false
          
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/*.xml'
              failTaskOnFailedTests: false
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Playwright Report'
            condition: always()
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report-${{ parameters.testSuite }}'
              publishLocation: 'pipeline'
