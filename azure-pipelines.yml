trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - 'tests/**'
      - 'src/**'
      - 'package.json'
      - 'playwright.config.ts'

pr:
  branches:
    include:
      - main
      - develop

schedules:
  # Run tests daily at 2 AM UTC
  - cron: "0 2 * * *"
    displayName: Daily test run
    branches:
      include:
        - main
    always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'

stages:
  - stage: Test
    displayName: 'Run Playwright Tests'
    jobs:
      - job: AccountManagement
        displayName: 'Account Management Tests'
        timeoutInMinutes: 30
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'
          
          - script: npm run test:account-management:ci
            displayName: 'Run Account Management Tests'
            continueOnError: false
          
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/*.xml'
              failTaskOnFailedTests: false
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Playwright Report'
            condition: always()
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report-account-management'
              publishLocation: 'pipeline'
      
      - job: AllModules
        displayName: 'All Module Tests'
        timeoutInMinutes: 60
        dependsOn: AccountManagement
        condition: succeededOrFailed()
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'
          
          - script: npm run test:all-modules:ci
            displayName: 'Run All Module Tests'
            continueOnError: true
          
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/*.xml'
              failTaskOnFailedTests: false
          
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Playwright Report'
            condition: always()
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report-all-modules'
              publishLocation: 'pipeline'
